<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - Colegio Leonard Eulerd</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0A6EB4 0%, #0859A0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #0A6EB4;
        }
        .logo { max-width: 300px; margin: 0 auto 20px; }
        .logo img { width: 100%; height: auto; }
        h1 { color: #0A6EB4; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #555; margin-bottom: 10px; font-size: 1.1em; }
        .motto { text-align: center; color: #0A6EB4; font-weight: bold; font-size: 1.2em; font-style: italic; }
        .cloud-status {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .cloud-status.disconnected { background: #ffebee; border-color: #f44336; }
        .cloud-status.syncing { background: #fff3e0; border-color: #ff9800; }
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 10000;
            display: none;
        }
        .sync-indicator.syncing { background: #ff9800; display: block; }
        .sync-indicator.error { background: #f44336; display: block; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .tab {
            padding: 15px 30px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab.active { color: #0A6EB4; border-bottom-color: #0A6EB4; font-weight: bold; }
        .tab:hover { color: #0A6EB4; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            display: none;
        }
        .status-box.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status-box.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .status-box.info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary { background: #0A6EB4; color: white; }
        .btn-primary:hover { background: #0859A0; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(10, 110, 180, 0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #0A6EB4; }
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #0A6EB4;
        }
        .student-card h3 { color: #333; margin-bottom: 5px; }
        .student-card p { color: #666; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        table th { background: #0A6EB4; color: white; font-weight: bold; }
        table tr:hover { background: #f8f9fa; }
        .actions { text-align: center; margin-top: 20px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #0A6EB4 0%, #0859A0 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }
        .stat-card h3 { font-size: 36px; margin-bottom: 10px; }
        .stat-card p { font-size: 14px; opacity: 0.9; }
        .manual-entry { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .config-section {
            background: #fff9e6;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .backup-section {
            background: #e3f2fd;
            border: 2px solid #0A6EB4;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .backup-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #0A6EB4;
        }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
        .file-input-label {
            padding: 12px 30px;
            background: #0A6EB4;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
        }
        .file-input-label:hover { background: #0859A0; transform: translateY(-2px); }
        .scanner-box {
            background: linear-gradient(135deg, #0A6EB4 0%, #0859A0 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin: 30px 0;
        }
        .scanner-box h2 { color: white; margin-bottom: 20px; }
        .scanner-box p { color: white; font-size: 18px; margin-bottom: 20px; }
        .bluetooth-reader-box {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            border: 3px solid #155724;
        }
        .bluetooth-reader-box h3 { color: white; margin-bottom: 15px; font-size: 1.5em; }
        .bluetooth-reader-box p { color: white; font-size: 16px; margin-bottom: 15px; }
        .reader-input-field {
            background: white;
            border: 3px solid #155724;
            padding: 20px;
            border-radius: 10px;
            font-size: 24px;
            text-align: center;
            font-weight: bold;
            color: #333;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            letter-spacing: 2px;
            display: block;
        }
        .reader-input-field:focus { outline: none; border-color: #28a745; box-shadow: 0 0 20px rgba(40, 167, 69, 0.5); }
        .reader-status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            font-weight: bold;
        }
        .reader-status.active { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .reader-status.inactive { background: #fff3e0; color: #856404; border: 2px solid #ffeeba; }
        .scan-animation { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        #qr-reader {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        #qr-reader video { width: 100%; border-radius: 10px; }
        .camera-controls { margin: 20px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .camera-status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            font-weight: bold;
        }
        .camera-status.active { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .camera-status.inactive { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
        .mode-selector { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .mode-selector h3 { color: #0A6EB4; margin-bottom: 15px; }
        .mode-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .mode-btn {
            padding: 15px 30px;
            border: 3px solid #0A6EB4;
            background: white;
            color: #0A6EB4;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .mode-btn.active { background: #0A6EB4; color: white; }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(10, 110, 180, 0.3); }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalFadeIn 0.3s ease;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content h2 { color: #0A6EB4; margin-bottom: 15px; font-size: 2em; }
        .modal-content .student-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #0A6EB4;
        }
        .modal-content .student-info h3 { color: #333; margin-bottom: 10px; }
        .modal-content .student-info p { color: #666; font-size: 16px; margin: 5px 0; }
        .modal-content .uniform-question { font-size: 1.5em; color: #333; margin: 30px 0 20px 0; font-weight: bold; }
        .modal-buttons { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
        .btn-uniform-yes {
            background: #28a745;
            color: white;
            padding: 20px 50px;
            font-size: 1.3em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-uniform-yes:hover { background: #218838; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4); }
        .btn-uniform-no {
            background: #dc3545;
            color: white;
            padding: 20px 50px;
            font-size: 1.3em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-uniform-no:hover { background: #c82333; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4); }
        .incident-card { background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 5px solid #dc3545; }
        .incident-card.retardo { border-left-color: #ff9800; }
        .incident-card.uniforme { border-left-color: #ffc107; }
        .incident-summary { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .incident-summary h4 { color: #0A6EB4; margin-bottom: 15px; }
        .incident-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .incident-stat { background: white; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0; }
        .incident-stat h3 { font-size: 32px; margin-bottom: 5px; }
        .incident-stat.falta h3 { color: #dc3545; }
        .incident-stat.retardo h3 { color: #ff9800; }
        .incident-stat.uniforme h3 { color: #ffc107; }
        @media screen and (max-width: 768px) {
            .modal-content { max-width: 95%; padding: 30px 20px; }
            .btn-uniform-yes, .btn-uniform-no { padding: 15px 30px; font-size: 1.1em; width: 45%; }
            .modal-buttons { gap: 10px; }
            .uniform-question { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <div id="syncIndicator" class="sync-indicator">üîÑ Sincronizando...</div>

    <div id="uniformModal" class="modal-overlay">
        <div class="modal-content">
            <h2>üëî Verificaci√≥n de Uniforme</h2>
            <div class="student-info">
                <h3 id="modalStudentName"></h3>
                <p><strong>CURP:</strong> <span id="modalStudentCode"></span></p>
                <p><strong>Hora:</strong> <span id="modalTime"></span></p>
            </div>
            <p class="uniform-question">¬øUniforme Completo?</p>
            <div class="modal-buttons">
                <button class="btn-uniform-yes" onclick="confirmUniform(true)">‚úÖ S√ç</button>
                <button class="btn-uniform-no" onclick="confirmUniform(false)">‚ùå NO</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 400'%3E%3Crect width='800' height='400' fill='%230A6EB4'/%3E%3Ctext x='400' y='150' font-family='Arial' font-size='60' font-weight='bold' fill='white' text-anchor='middle'%3ECOLEGIO%3C/text%3E%3Ctext x='400' y='220' font-family='Arial' font-size='80' font-weight='bold' fill='white' text-anchor='middle'%3ELEONARD%3C/text%3E%3Ctext x='400' y='290' font-family='Arial' font-size='80' font-weight='bold' fill='white' text-anchor='middle'%3EEULERD%3C/text%3E%3C/svg%3E" alt="Colegio Leonard Eulerd">
            </div>
            <h1>üì± Sistema de Asistencia</h1>
            <p class="subtitle">Control de entrada y salida con Lector Bluetooth y C√°mara QR</p>
            <p class="motto">Estudia y Vencer√°s</p>
        </div>
        
        <div id="cloudStatus" class="cloud-status disconnected">
            ‚ö†Ô∏è No conectado a Google Sheets - Usando almacenamiento local
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('scanner', event)">üì∏ Esc√°ner</button>
            <button class="tab" onclick="showTab('students', event)">üë• Alumnos</button>
            <button class="tab" onclick="showTab('records', event)">üìä Registros</button>
            <button class="tab" onclick="showTab('reports', event)">üìà Reportes</button>
            <button class="tab" onclick="showTab('config', event)">‚öôÔ∏è Configuraci√≥n</button>
        </div>
        
        <!-- TAB: CONFIGURACI√ìN -->
        <div id="config" class="tab-content">
            <h2>‚öôÔ∏è Configuraci√≥n de Google Sheets</h2>
            <div class="config-section">
                <h3>üìù Instrucciones:</h3>
                <ol>
                    <li>Abre tu Google Sheet</li>
                    <li>Ve a <strong>Extensiones ‚Üí Apps Script</strong></li>
                    <li>Pega el c√≥digo del script proporcionado</li>
                    <li>Haz clic en <strong>Implementar ‚Üí Nueva implementaci√≥n</strong></li>
                    <li>Selecciona <strong>Aplicaci√≥n web</strong></li>
                    <li>Copia la URL de la aplicaci√≥n web</li>
                    <li>P√©gala aqu√≠ abajo y guarda</li>
                </ol>
            </div>
            <div class="form-group">
                <label>URL del Web App de Google Apps Script:</label>
                <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/...">
            </div>
            <div class="actions">
                <button class="btn btn-success" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                <button class="btn btn-primary" onclick="testConnection()">üîå Probar Conexi√≥n</button>
                <button class="btn btn-primary" onclick="manualSync()">üîÑ Sincronizar Ahora</button>
                <button class="btn btn-primary" onclick="syncToCloud()">‚òÅÔ∏è Sincronizar Todo a la Nube</button>
                <button class="btn btn-primary" onclick="loadFromCloud()">‚¨áÔ∏è Cargar Datos desde la Nube</button>
            </div>
            <div id="configStatus" class="status-box"></div>

            <h2 style="margin-top: 40px;">üíæ Respaldo Local de Datos</h2>
            <div class="backup-section">
                <h3>üì¶ Gesti√≥n de Respaldos</h3>
                <p>Protege tu informaci√≥n exportando e importando respaldos locales en formato JSON</p>
                <div class="backup-info">
                    <p><strong>üìä Total de Alumnos:</strong> <span id="totalStudents">0</span></p>
                    <p><strong>üìù Total de Registros:</strong> <span id="totalRecords">0</span></p>
                    <p><strong>üïê √öltimo respaldo:</strong> <span id="lastBackup">Nunca</span></p>
                </div>
                <div class="actions">
                    <button class="btn btn-success" onclick="exportBackup()">üì• Descargar Respaldo Completo</button>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".json" onchange="importBackup(event)">
                        <label for="fileInput" class="file-input-label">üì§ Importar Respaldo</label>
                    </div>
                    <button class="btn btn-warning" onclick="exportStudentsOnly()">üë• Exportar Alumnos</button>
                    <button class="btn btn-warning" onclick="exportRecordsOnly()">üìä Exportar Registros</button>
                </div>
            </div>
            <div id="backupStatus" class="status-box"></div>
        </div>
        
        <!-- TAB: ESC√ÅNER -->
        <div id="scanner" class="tab-content active">
            <div class="form-group">
                <label>Tipo de Registro:</label>
                <select id="recordType">
                    <option value="entrada">Entrada</option>
                    <option value="salida">Salida</option>
                </select>
            </div>

            <div class="mode-selector">
                <h3>Seleccione el modo de escaneo:</h3>
                <div class="mode-buttons">
                    <button class="mode-btn active" onclick="setMode('bluetooth', event)">üì± Lector Bluetooth/USB</button>
                    <button class="mode-btn" onclick="setMode('camera', event)">üì∏ C√°mara Web</button>
                    <button class="mode-btn" onclick="setMode('manual', event)">‚å®Ô∏è Entrada Manual</button>
                </div>
            </div>

            <div id="bluetoothMode" class="bluetooth-reader-box">
                <h3>üì± Lector de C√≥digos Bluetooth/USB</h3>
                <p>Coloque el cursor en el campo y escanee el c√≥digo con su lector</p>
                <div id="readerStatus" class="reader-status active">‚úÖ Listo para escanear - Haga clic en el campo y escanee</div>
                <input type="text" id="bluetoothInput" class="reader-input-field" placeholder="Escanee aqu√≠..." autocomplete="off" autofocus>
                <p style="font-size: 14px; margin-top: 15px;">üí° El lector debe estar emparejado y configurado como teclado HID</p>
            </div>
            
            <div id="cameraMode" class="scanner-box" style="display: none;">
                <h2>üì∏ Esc√°ner de C√°mara</h2>
                <p>Apunte la c√°mara al c√≥digo QR o c√≥digo de barras del alumno</p>
                <div class="camera-controls">
                    <button class="btn btn-success" onclick="startCamera()">‚ñ∂Ô∏è Iniciar C√°mara</button>
                    <button class="btn btn-danger" onclick="stopCamera()">‚èπÔ∏è Detener C√°mara</button>
                </div>
                <div id="cameraStatus" class="camera-status inactive">üì∑ C√°mara detenida</div>
                <div id="qr-reader"></div>
            </div>

            <div id="manualMode" class="manual-entry" style="display: none;">
                <h3>‚å®Ô∏è Ingrese el c√≥digo manualmente</h3>
                <div class="form-group">
                    <label>C√≥digo del Alumno:</label>
                    <input type="text" id="manualCode" placeholder="Ingrese el c√≥digo y presione Enter">
                </div>
                <button class="btn btn-success" onclick="processManualCode()">‚úÖ Registrar</button>
            </div>
            
            <div id="statusMessage" class="status-box"></div>
        </div>
        
        <!-- TAB: ALUMNOS -->
        <div id="students" class="tab-content">
            <h2>Gesti√≥n de Alumnos</h2>
            <div class="backup-section">
                <h3>üì• Importar Lista de Alumnos desde CSV</h3>
                <p>El archivo CSV debe contener: Nombre | CURP | Semestre | Grupo</p>
                <div class="actions">
                    <div class="file-input-wrapper">
                        <input type="file" id="csvStudentsInput" accept=".csv" onchange="importStudentsCSV(event)">
                        <label for="csvStudentsInput" class="file-input-label">üì§ Seleccionar Archivo CSV</label>
                    </div>
                </div>
                <div id="importStudentsStatus" class="status-box"></div>
            </div>

            <h3 style="margin-top: 30px;">‚ûï Agregar Alumno Manualmente</h3>
            <div class="form-group">
                <label>Nombre del Alumno:</label>
                <input type="text" id="studentName" placeholder="Ej: Juan P√©rez Garc√≠a">
            </div>
            <div class="form-group">
                <label>CURP:</label>
                <input type="text" id="studentCURP" placeholder="Ej: PEGJ950101HDFRRL09" maxlength="18">
            </div>
            <div class="form-group">
                <label>Semestre:</label>
                <input type="text" id="studentSemester" placeholder="Ej: 3">
            </div>
            <div class="form-group">
                <label>Grupo:</label>
                <input type="text" id="studentGroup" placeholder="Ej: A">
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="addStudent()">‚ûï Agregar Alumno</button>
            </div>
            <div id="studentsList" class="students-grid"></div>
        </div>
        
        <!-- TAB: REGISTROS -->
        <div id="records" class="tab-content">
            <h2>Registros de Asistencia</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 2px solid #0A6EB4;">
                <p style="margin: 0; color: #0A6EB4; font-weight: bold;">‚òÅÔ∏è Los registros se cargan autom√°ticamente desde Google Sheets</p>
            </div>
            <div class="form-group">
                <label>Filtrar por Fecha:</label>
                <input type="date" id="filterDate" onchange="filterRecords()">
            </div>
            <div class="actions">
                <button class="btn btn-success" onclick="exportToCSV()">üì• Exportar a Excel (CSV)</button>
                <button class="btn btn-danger" onclick="clearRecords()">üóëÔ∏è Limpiar Registros</button>
            </div>
            <div id="recordsTable"></div>
        </div>
        
        <!-- TAB: REPORTES -->
        <div id="reports" class="tab-content">
            <h2>Reportes y Estad√≠sticas</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 2px solid #0A6EB4;">
                <p style="margin: 0; color: #0A6EB4; font-weight: bold;">‚òÅÔ∏è Los reportes se generan con datos actualizados desde Google Sheets</p>
            </div>
            <div class="backup-section" style="background: #fff3e0; border-color: #ff9800;">
                <h3>üìã Reporte de Incidencias del D√≠a</h3>
                <p>Genera un PDF con todas las incidencias del d√≠a seleccionado</p>
                <div class="form-group">
                    <label>Seleccionar Fecha para el Reporte:</label>
                    <input type="date" id="incidentDate">
                </div>
                <div class="actions">
                    <button class="btn btn-danger" onclick="generateIncidentsReport()">üìÑ Generar Reporte de Incidencias (PDF)</button>
                </div>
                <div id="incidentsPreview" style="margin-top: 20px;"></div>
            </div>
            <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0;">
            <h3>üìä Reporte Semanal</h3>
            <div class="form-group">
                <label>Seleccionar Semana:</label>
                <input type="week" id="weekSelect" onchange="generateWeeklyReport()">
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div id="weeklyReport"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script>
        // ========== VARIABLES GLOBALES ==========
        let students = [];
        let attendanceRecords = [];
        let webAppUrl = '';
        let isCloudConnected = false;
        let html5QrCode = null;
        let isCameraActive = false;
        let currentMode = 'bluetooth';
        let pendingRecord = null;

        // ========== INICIALIZACI√ìN ==========
        window.onload = function() {
            loadData();
            loadConfig();
            displayStudents();
            displayRecords();
            setTodayDate();
            setupManualInput();
            setupBluetoothReader();
            updateBackupInfo();
            setMode('bluetooth', null);
            setIncidentDate();
            autoSyncOnStart();
            startAutoSync();
        };

        // ========== UTILIDADES ==========
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'status-box ' + type;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, type === 'info' ? 5000 : 3000);
        }

        function loadData() {
            const storedStudents = localStorage.getItem('students');
            const storedRecords = localStorage.getItem('attendanceRecords');
            if (storedStudents) students = JSON.parse(storedStudents);
            if (storedRecords) attendanceRecords = JSON.parse(storedRecords);
        }

        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            updateBackupInfo();
        }

        function setTodayDate() {
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
        }

        function setIncidentDate() {
            document.getElementById('incidentDate').value = new Date().toISOString().split('T')[0];
        }

        function setupManualInput() {
            document.getElementById('manualCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); processManualCode(); }
            });
        }

        // ========== MODAL DE UNIFORME ==========
        function showUniformModal(student, recordData) {
            pendingRecord = recordData;
            document.getElementById('modalStudentName').textContent = student.name;
            document.getElementById('modalStudentCode').textContent = student.code;
            document.getElementById('modalTime').textContent = recordData.time;
            document.getElementById('uniformModal').classList.add('active');
        }

        function hideUniformModal() {
            document.getElementById('uniformModal').classList.remove('active');
            pendingRecord = null;
            if (currentMode === 'camera' && html5QrCode && isCameraActive) {
                setTimeout(() => { html5QrCode.resume(); }, 500);
            }
            if (currentMode === 'bluetooth') {
                setTimeout(() => { document.getElementById('bluetoothInput').focus(); }, 100);
            } else if (currentMode === 'manual') {
                setTimeout(() => { document.getElementById('manualCode').focus(); }, 100);
            }
        }

        async function confirmUniform(hasUniform) {
            if (!pendingRecord) return;
            pendingRecord.uniformComplete = hasUniform;
            attendanceRecords.push(pendingRecord);
            saveData();
            if (isCloudConnected) {
                await saveToCloud('saveRecord', { action: 'saveRecord', record: pendingRecord });
            }
            const uniformIcon = hasUniform ? '‚úÖ' : '‚ùå';
            const uniformText = hasUniform ? 'CON UNIFORME' : 'SIN UNIFORME COMPLETO';
            const punctualityIcon = pendingRecord.punctualityStatus === 'PUNTUAL' ? '‚úÖ' : 
                                   pendingRecord.punctualityStatus === 'RETARDO' ? '‚ö†Ô∏è' : '‚ùå';
            let statusMessage = `üü¢ ENTRADA registrada: ${pendingRecord.studentName} - ${pendingRecord.time}<br>`;
            if (pendingRecord.punctualityStatus) {
                statusMessage += `<strong>${punctualityIcon} ${pendingRecord.punctualityStatus}</strong><br>`;
            }
            statusMessage += `<strong>${uniformIcon} ${uniformText}</strong>`;
            showStatus(statusMessage, 'success');
            hideUniformModal();
        }

        // ========== LECTOR BLUETOOTH ==========
        function setupBluetoothReader() {
            const bluetoothInput = document.getElementById('bluetoothInput');
            bluetoothInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const code = bluetoothInput.value.trim();
                    if (code) {
                        processCode(code);
                        bluetoothInput.value = '';
                        bluetoothInput.classList.add('scan-animation');
                        setTimeout(() => { bluetoothInput.classList.remove('scan-animation'); }, 500);
                    }
                }
            });
            bluetoothInput.addEventListener('focus', () => updateReaderStatus(true));
            bluetoothInput.addEventListener('blur', () => updateReaderStatus(false));
            document.addEventListener('click', function(e) {
                if (currentMode === 'bluetooth' && !e.target.matches('input, button, select, a, label')) {
                    setTimeout(() => {
                        if (!document.getElementById('uniformModal').classList.contains('active')) {
                            document.getElementById('bluetoothInput').focus();
                        }
                    }, 100);
                }
            });
        }

        function updateReaderStatus(active) {
            const statusDiv = document.getElementById('readerStatus');
            statusDiv.className = 'reader-status ' + (active ? 'active' : 'inactive');
            statusDiv.textContent = active ? '‚úÖ Listo para escanear - Campo activo' : '‚ö†Ô∏è Haga clic en el campo para activar';
        }

        // ========== MODOS DE ESCANEO ==========
        function setMode(mode, evt) {
            if (isCameraActive) stopCamera();
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if (evt && evt.target) evt.target.classList.add('active');
            document.getElementById('bluetoothMode').style.display = mode === 'bluetooth' ? 'block' : 'none';
            document.getElementById('cameraMode').style.display = mode === 'camera' ? 'block' : 'none';
            document.getElementById('manualMode').style.display = mode === 'manual' ? 'block' : 'none';
            if (mode === 'bluetooth') setTimeout(() => document.getElementById('bluetoothInput').focus(), 100);
            else if (mode === 'manual') setTimeout(() => document.getElementById('manualCode').focus(), 100);
        }

        // ========== C√ÅMARA ==========
        function startCamera() {
            if (isCameraActive) { showStatus('‚ö†Ô∏è La c√°mara ya est√° activa', 'info'); return; }
            if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, () => {})
                .then(() => { isCameraActive = true; updateCameraStatus(true); showStatus('‚úÖ C√°mara iniciada', 'success'); })
                .catch(err => { showStatus('‚ùå Error al iniciar c√°mara: ' + err, 'error'); updateCameraStatus(false); });
        }

        function stopCamera() {
            if (!isCameraActive || !html5QrCode) { showStatus('‚ö†Ô∏è La c√°mara no est√° activa', 'info'); return; }
            html5QrCode.stop().then(() => { isCameraActive = false; updateCameraStatus(false); showStatus('üõë C√°mara detenida', 'info'); });
        }

        function onScanSuccess(decodedText) {
            if (html5QrCode && isCameraActive) html5QrCode.pause(true);
            processCode(decodedText);
        }

        function updateCameraStatus(active) {
            const statusDiv = document.getElementById('cameraStatus');
            statusDiv.className = 'camera-status ' + (active ? 'active' : 'inactive');
            statusDiv.textContent = active ? '‚úÖ C√°mara activa - Escanee el c√≥digo' : 'üì∑ C√°mara detenida';
        }

        // ========== TABS ==========
        function showTab(tabName, evt) {
            if (isCameraActive && tabName !== 'scanner') stopCamera();
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (evt && evt.target) evt.target.classList.add('active');
            if (tabName === 'records') displayRecords();
            else if (tabName === 'reports') generateWeeklyReport();
            else if (tabName === 'config') updateBackupInfo();
            else if (tabName === 'scanner' && currentMode === 'bluetooth') setTimeout(() => document.getElementById('bluetoothInput').focus(), 100);
        }

        // ========== PROCESAMIENTO DE C√ìDIGOS ==========
        function processManualCode() {
            const code = document.getElementById('manualCode').value.trim();
            if (!code) { showStatus('Por favor ingrese un c√≥digo', 'error'); return; }
            processCode(code);
            document.getElementById('manualCode').value = '';
        }

        async function processCode(code) {
            const student = students.find(s => s.code === code);
            if (!student) {
                showStatus('‚ùå Alumno no encontrado: ' + code, 'error');
                if (currentMode === 'camera' && html5QrCode && isCameraActive) setTimeout(() => html5QrCode.resume(), 2000);
                return;
            }
            const recordType = document.getElementById('recordType').value;
            const now = new Date();
            const todayDate = now.toLocaleDateString('es-MX');
            const existingRecord = attendanceRecords.find(r => r.studentCode === code && r.date === todayDate && r.type === recordType);
            if (existingRecord) {
                const typeText = recordType === 'entrada' ? 'ENTRADA' : 'SALIDA';
                showStatus(`‚ö†Ô∏è ${typeText} DE ALUMNO YA SE REGISTR√ì ANTES<br><strong>${student.name}</strong><br><strong>Hora: ${existingRecord.time}</strong>`, 'info');
                if (currentMode === 'camera' && html5QrCode && isCameraActive) setTimeout(() => html5QrCode.resume(), 3000);
                return;
            }
            let punctualityStatus = '';
            if (recordType === 'entrada') {
                const totalMinutes = now.getHours() * 60 + now.getMinutes();
                if (totalMinutes >= 390 && totalMinutes < 420) punctualityStatus = 'PUNTUAL';
                else if (totalMinutes >= 420 && totalMinutes < 425) punctualityStatus = 'RETARDO';
                else if (totalMinutes >= 425) punctualityStatus = 'FALTA POR IMPUNTUALIDAD';
                else punctualityStatus = 'ENTRADA ANTICIPADA';
            }
            const record = {
                studentCode: code, studentName: student.name, type: recordType,
                date: todayDate, time: now.toLocaleTimeString('es-MX'),
                timestamp: now.getTime(), punctualityStatus: punctualityStatus, uniformComplete: null
            };
            if (recordType === 'entrada') {
                setTimeout(() => showUniformModal(student, record), 300);
            } else {
                attendanceRecords.push(record);
                saveData();
                if (isCloudConnected) await saveToCloud('saveRecord', { action: 'saveRecord', record: record });
                showStatus(`üî¥ SALIDA registrada: ${student.name} - ${record.time}`, 'success');
                if (currentMode === 'camera' && html5QrCode && isCameraActive) setTimeout(() => html5QrCode.resume(), 2000);
            }
        }

        // ========== GESTI√ìN DE ALUMNOS ==========
        async function addStudent() {
            const name = document.getElementById('studentName').value.trim();
            const curp = document.getElementById('studentCURP').value.trim().toUpperCase();
            const semester = document.getElementById('studentSemester').value.trim();
            const group = document.getElementById('studentGroup').value.trim();
            if (!name || !curp) { alert('Por favor complete nombre y CURP'); return; }
            if (curp.length !== 18) { alert('El CURP debe tener exactamente 18 caracteres'); return; }
            if (students.find(s => s.code === curp)) { alert('Ya existe un alumno con ese CURP'); return; }
            students.push({ name, code: curp, curp, semester, group, grade: `${semester}¬∞ ${group}` });
            saveData();
            if (isCloudConnected) await saveToCloud('saveStudents', { action: 'saveStudents', students });
            ['studentName', 'studentCURP', 'studentSemester', 'studentGroup'].forEach(id => document.getElementById(id).value = '');
            displayStudents();
            alert('Alumno agregado exitosamente');
        }

        function displayStudents() {
            const container = document.getElementById('studentsList');
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay alumnos registrados</p>';
                return;
            }
            container.innerHTML = students.map((student, index) => `
                <div class="student-card">
                    <h3>${escapeHtml(student.name)}</h3>
                    <p><strong>CURP:</strong> ${escapeHtml(student.curp || student.code)}</p>
                    <p><strong>Semestre:</strong> ${escapeHtml(student.semester || 'N/A')}</p>
                    <p><strong>Grupo:</strong> ${escapeHtml(student.group || 'N/A')}</p>
                    <button class="btn btn-danger" onclick="deleteStudent(${index})" style="width: 100%; margin-top: 10px;">Eliminar</button>
                </div>
            `).join('');
        }

        async function deleteStudent(index) {
            if (confirm('¬øEliminar este alumno?')) {
                students.splice(index, 1);
                saveData();
                if (isCloudConnected) await saveToCloud('saveStudents', { action: 'saveStudents', students });
                displayStudents();
            }
        }

        function importStudentsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    if (lines.length < 2) { showImportStatus('‚ùå Archivo vac√≠o', 'error'); return; }
                    if (students.length > 0) {
                        const shouldAdd = confirm(`Ya hay ${students.length} alumnos.\n¬øAgregar nuevos? OK=Agregar, Cancelar=Reemplazar`);
                        if (!shouldAdd && confirm('¬øEliminar todos los alumnos actuales?')) students = [];
                        else if (!shouldAdd) { event.target.value = ''; return; }
                    }
                    let imported = 0, skipped = 0, errors = 0;
                    const hasHeader = lines[0].toLowerCase().includes('nombre') || lines[0].toLowerCase().includes('curp');
                    for (let i = hasHeader ? 1 : 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const cols = line.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                        if (cols.length < 4) { errors++; continue; }
                        const [name, curp, semester, group] = [cols[0], cols[1].toUpperCase(), cols[2], cols[3]];
                        if (!name || !curp) { errors++; continue; }
                        if (students.find(s => s.code === curp)) { skipped++; continue; }
                        students.push({ name, code: curp, curp, semester, group, grade: `${semester}¬∞ ${group}` });
                        imported++;
                    }
                    saveData();
                    displayStudents();
                    showImportStatus(`‚úÖ ${imported} importados${skipped ? ', ' + skipped + ' duplicados' : ''}${errors ? ', ' + errors + ' errores' : ''}`, imported > 0 ? 'success' : 'error');
                } catch (err) { showImportStatus('‚ùå Error: ' + err.message, 'error'); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function showImportStatus(msg, type) {
            const div = document.getElementById('importStudentsStatus');
            div.className = 'status-box ' + type;
            div.innerHTML = msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 7000);
        }

        // ========== REGISTROS ==========
        function displayRecords() {
            const container = document.getElementById('recordsTable');
            const filterDate = document.getElementById('filterDate').value;
            let filtered = attendanceRecords;
            if (filterDate) {
                const filterDateStr = new Date(filterDate + 'T00:00:00').toLocaleDateString('es-MX');
                filtered = attendanceRecords.filter(r => r.date === filterDateStr);
            }
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay registros</p>';
                return;
            }
            const grouped = {};
            filtered.forEach(r => {
                const key = `${r.studentCode}_${r.date}`;
                if (!grouped[key]) grouped[key] = { studentName: r.studentName, studentCode: r.studentCode, date: r.date, entrada: '', salida: '', punctualityStatus: '', uniformComplete: null, timestamp: r.timestamp };
                if (r.type === 'entrada') { grouped[key].entrada = r.time; grouped[key].punctualityStatus = r.punctualityStatus || ''; grouped[key].uniformComplete = r.uniformComplete; }
                else grouped[key].salida = r.time;
            });
            const sorted = Object.values(grouped).sort((a, b) => b.timestamp - a.timestamp);
            container.innerHTML = `<table><thead><tr><th>Fecha</th><th>Alumno</th><th>Entrada</th><th>Estado</th><th>Uniforme</th><th>Salida</th></tr></thead><tbody>
                ${sorted.map(r => {
                    let statusCell = '-', statusColor = '';
                    if (r.punctualityStatus === 'PUNTUAL') { statusCell = '‚úÖ PUNTUAL'; statusColor = 'background:#d4edda;'; }
                    else if (r.punctualityStatus === 'RETARDO') { statusCell = '‚ö†Ô∏è RETARDO'; statusColor = 'background:#fff3cd;'; }
                    else if (r.punctualityStatus === 'FALTA POR IMPUNTUALIDAD') { statusCell = '‚ùå FALTA'; statusColor = 'background:#f8d7da;'; }
                    else if (r.punctualityStatus === 'ENTRADA ANTICIPADA') { statusCell = 'üïê ANTICIPADA'; statusColor = 'background:#d1ecf1;'; }
                    const uniformCell = r.uniformComplete === true ? '‚úÖ S√ç' : r.uniformComplete === false ? '‚ùå NO' : '-';
                    return `<tr style="${statusColor}"><td>${r.date}</td><td><strong>${escapeHtml(r.studentName)}</strong></td><td>${r.entrada || '-'}</td><td>${statusCell}</td><td>${uniformCell}</td><td>${r.salida || '-'}</td></tr>`;
                }).join('')}
            </tbody></table>`;
        }

        async function filterRecords() {
            if (isCloudConnected) await syncAndWait();
            displayRecords();
        }

        function clearRecords() {
            if (confirm('¬øEliminar TODOS los registros?')) { attendanceRecords = []; saveData(); displayRecords(); }
        }

        async function exportToCSV() {
            if (isCloudConnected) await syncAndWait();
            if (attendanceRecords.length === 0) { alert('No hay registros'); return; }
            const grouped = {};
            attendanceRecords.forEach(r => {
                const key = `${r.studentCode}_${r.date}`;
                if (!grouped[key]) grouped[key] = { studentName: r.studentName, date: r.date, entrada: '', salida: '', punctualityStatus: '', uniformComplete: '' };
                if (r.type === 'entrada') { grouped[key].entrada = r.time; grouped[key].punctualityStatus = r.punctualityStatus || ''; grouped[key].uniformComplete = r.uniformComplete === true ? 'S√ç' : r.uniformComplete === false ? 'NO' : ''; }
                else grouped[key].salida = r.time;
            });
            let csv = 'Fecha,Alumno,Entrada,Estado,Uniforme,Salida\n';
            Object.values(grouped).forEach(r => csv += `${r.date},${r.studentName},${r.entrada},${r.punctualityStatus},${r.uniformComplete},${r.salida}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `asistencia_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ========== RESPALDOS ==========
        function updateBackupInfo() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalRecords').textContent = attendanceRecords.length;
            const lastBackup = localStorage.getItem('lastBackupDate');
            document.getElementById('lastBackup').textContent = lastBackup ? new Date(lastBackup).toLocaleString('es-MX') : 'Nunca';
        }

        function exportBackup() {
            const data = { version: '1.0', exportDate: new Date().toISOString(), students, attendanceRecords, webAppUrl };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `respaldo_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            localStorage.setItem('lastBackupDate', new Date().toISOString());
            updateBackupInfo();
            showBackupStatus('‚úÖ Respaldo descargado', 'success');
        }

        function exportStudentsOnly() {
            const blob = new Blob([JSON.stringify({ version: '1.0', exportDate: new Date().toISOString(), students }, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `alumnos_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showBackupStatus('‚úÖ Alumnos exportados', 'success');
        }

        function exportRecordsOnly() {
            const blob = new Blob([JSON.stringify({ version: '1.0', exportDate: new Date().toISOString(), attendanceRecords }, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `registros_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showBackupStatus('‚úÖ Registros exportados', 'success');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.version) { showBackupStatus('‚ùå Archivo inv√°lido', 'error'); return; }
                    if ((students.length || attendanceRecords.length) && !confirm(`Reemplazar datos actuales?\nAlumnos: ${students.length} ‚Üí ${data.students?.length || 0}\nRegistros: ${attendanceRecords.length} ‚Üí ${data.attendanceRecords?.length || 0}`)) {
                        event.target.value = ''; return;
                    }
                    if (data.students) students = data.students;
                    if (data.attendanceRecords) attendanceRecords = data.attendanceRecords;
                    if (data.webAppUrl) { webAppUrl = data.webAppUrl; localStorage.setItem('webAppUrl', webAppUrl); document.getElementById('webAppUrl').value = webAppUrl; }
                    saveData(); displayStudents(); displayRecords(); updateBackupInfo();
                    showBackupStatus(`‚úÖ Importado: ${data.students?.length || 0} alumnos, ${data.attendanceRecords?.length || 0} registros`, 'success');
                } catch (err) { showBackupStatus('‚ùå Error: ' + err.message, 'error'); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function showBackupStatus(msg, type) {
            const div = document.getElementById('backupStatus');
            div.className = 'status-box ' + type;
            div.innerHTML = msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        // ========== CONFIGURACI√ìN Y NUBE ==========
        function loadConfig() {
            webAppUrl = localStorage.getItem('webAppUrl') || '';
            if (webAppUrl) { document.getElementById('webAppUrl').value = webAppUrl; testConnection(); }
        }

        function saveConfig() {
            webAppUrl = document.getElementById('webAppUrl').value.trim();
            if (!webAppUrl) { alert('Ingrese una URL v√°lida'); return; }
            localStorage.setItem('webAppUrl', webAppUrl);
            showConfigStatus('‚úÖ Guardado. Probando...', 'success');
            testConnection();
        }

        async function testConnection() {
            if (!webAppUrl) { showConfigStatus('‚ùå Configure la URL primero', 'error'); return; }
            showConfigStatus('üîÑ Probando...', 'info');
            try {
                const response = await fetch(webAppUrl + '?action=getStudents');
                const data = await response.json();
                isCloudConnected = data.success;
                showConfigStatus(data.success ? '‚úÖ Conexi√≥n exitosa' : '‚ùå Error: ' + (data.error || 'Desconocido'), data.success ? 'success' : 'error');
            } catch (err) { isCloudConnected = false; showConfigStatus('‚ùå Error: ' + err.message, 'error'); }
            updateCloudStatus();
        }

        function updateCloudStatus() {
            const div = document.getElementById('cloudStatus');
            div.className = 'cloud-status ' + (isCloudConnected ? '' : 'disconnected');
            div.innerHTML = isCloudConnected ? '‚úÖ Conectado a Google Sheets - Sincronizaci√≥n autom√°tica (30 seg)' : '‚ö†Ô∏è No conectado - Configure en Configuraci√≥n';
        }

        async function saveToCloud(endpoint, data) {
            if (!isCloudConnected || !webAppUrl) return false;
            try {
                const response = await fetch(webAppUrl, { method: 'POST', body: JSON.stringify(data) });
                return (await response.json()).success;
            } catch (err) { console.error('Error guardando:', err); return false; }
        }

        async function syncToCloud() {
            if (!webAppUrl) { alert('Configure la URL primero'); showTab('config', null); return; }
            showConfigStatus('üîÑ Sincronizando...', 'info');
            try {
                await saveToCloud('saveStudents', { action: 'saveStudents', students });
                for (const record of attendanceRecords) await saveToCloud('saveRecord', { action: 'saveRecord', record });
                showConfigStatus('‚úÖ Sincronizaci√≥n completada', 'success');
            } catch (err) { showConfigStatus('‚ùå Error: ' + err.message, 'error'); }
        }

        async function loadFromCloud() {
            if (!webAppUrl) { alert('Configure la URL primero'); showTab('config', null); return; }
            showConfigStatus('üîÑ Cargando...', 'info');
            try {
                const studentsRes = await fetch(webAppUrl + '?action=getStudents');
                const studentsData = await studentsRes.json();
                if (studentsData.success && studentsData.students?.length) students = studentsData.students;
                const recordsRes = await fetch(webAppUrl + '?action=getRecords');
                const recordsData = await recordsRes.json();
                if (recordsData.success && recordsData.records?.length) attendanceRecords = recordsData.records;
                saveData(); displayStudents(); displayRecords(); updateBackupInfo();
                showConfigStatus('‚úÖ Datos cargados', 'success');
            } catch (err) { showConfigStatus('‚ùå Error: ' + err.message, 'error'); }
        }

        function showConfigStatus(msg, type) {
            const div = document.getElementById('configStatus');
            div.className = 'status-box ' + type;
            div.innerHTML = msg;
            div.style.display = 'block';
        }

        // ========== SINCRONIZACI√ìN AUTOM√ÅTICA ==========
        async function syncAndWait() {
            if (!isCloudConnected || !webAppUrl) return false;
            try {
                showSyncIndicator('syncing');
                const studentsRes = await fetch(webAppUrl + '?action=getStudents');
                const studentsData = await studentsRes.json();
                if (studentsData.success && studentsData.students) students = studentsData.students;
                const recordsRes = await fetch(webAppUrl + '?action=getRecords');
                const recordsData = await recordsRes.json();
                if (recordsData.success && recordsData.records) attendanceRecords = recordsData.records;
                saveData();
                showSyncIndicator('success');
                return true;
            } catch (err) { console.error('Error sync:', err); showSyncIndicator('error'); return false; }
        }

        async function autoSyncOnStart() {
            webAppUrl = localStorage.getItem('webAppUrl') || '';
            if (!webAppUrl) { updateCloudStatus(); return; }
            try {
                showSyncIndicator('syncing');
                const response = await fetch(webAppUrl + '?action=getStudents');
                const data = await response.json();
                if (data.success) { isCloudConnected = true; await syncFromCloud(); showSyncIndicator('success'); }
                else isCloudConnected = false;
            } catch (err) { isCloudConnected = false; console.error('Error:', err); }
            updateCloudStatus();
        }

        async function syncFromCloud() {
            if (!webAppUrl || !isCloudConnected) return;
            try {
                showSyncIndicator('syncing');
                const studentsRes = await fetch(webAppUrl + '?action=getStudents');
                const studentsData = await studentsRes.json();
                if (studentsData.success && studentsData.students) students = studentsData.students;
                const recordsRes = await fetch(webAppUrl + '?action=getRecords');
                const recordsData = await recordsRes.json();
                if (recordsData.success && recordsData.records) attendanceRecords = recordsData.records;
                saveData();
                showSyncIndicator('success');
            } catch (err) { console.error('Error sync:', err); showSyncIndicator('error'); }
        }

        function startAutoSync() {
            setInterval(async () => { if (isCloudConnected && webAppUrl) await syncFromCloud(); }, 30000);
        }

        function showSyncIndicator(status) {
            const ind = document.getElementById('syncIndicator');
            ind.className = 'sync-indicator';
            if (status === 'syncing') { ind.className = 'sync-indicator syncing'; ind.textContent = 'üîÑ Sincronizando...'; }
            else if (status === 'success') { ind.style.background = '#4caf50'; ind.style.display = 'block'; ind.textContent = '‚úÖ Sincronizado'; setTimeout(() => ind.style.display = 'none', 2000); }
            else if (status === 'error') { ind.className = 'sync-indicator error'; ind.textContent = '‚ùå Error'; setTimeout(() => ind.style.display = 'none', 3000); }
        }

        async function manualSync() {
            if (!isCloudConnected || !webAppUrl) { alert('No conectado'); return; }
            showConfigStatus('üîÑ Sincronizando...', 'info');
            await syncFromCloud();
            showConfigStatus('‚úÖ Sincronizado', 'success');
        }
¬°Excelente! No hay incidencias'); document.getElementById('incidentsPreview').innerHTML = '<div class="status-box success" style="display:block;">‚úÖ Sin incidencias</div>'; return; }
            let faltas = 0, retardos = 0, sinUniforme = 0;
            list.forEach(s => s.list.forEach(i => { if (i.type === 'falta') faltas++; if (i.type === 'retardo') retardos++; if (i.type === 'uniforme') sinUniforme++; }));
            showIncidentsPreview(list, dateStr, faltas, retardos, sinUniforme);
            generateIncidentsPDF(list, dateStr, faltas, retardos, sinUniforme);
        }

        function showIncidentsPreview(list, dateStr, faltas, retardos, sinUniforme) {
            document.getElementById('incidentsPreview').innerHTML = `
                <div class="incident-summary"><h4>Resumen - ${dateStr}</h4>
                    <div class="incident-stats">
                        <div class="incident-stat falta"><h3>${faltas}</h3><p>Faltas</p></div>
                        <div class="incident-stat retardo"><h3>${retardos}</h3><p>Retardos</p></div>
                        <div class="incident-stat uniforme"><h3>${sinUniforme}</h3><p>Sin Uniforme</p></div>
                        <div class="incident-stat"><h3>${list.length}</h3><p>Alumnos</p></div>
                    </div>
                </div>
                <h4 style="margin:20px 0;">Detalle:</h4>
                ${list.map(s => `<div class="incident-card ${s.list[0].type}"><h4>${escapeHtml(s.name)}</h4><p><strong>CURP:</strong> ${escapeHtml(s.code)}</p><p><strong>Hora:</strong> ${s.time}</p>
                    ${s.list.map(i => `<div style="background:white;padding:10px;margin:5px 0;border-radius:5px;border-left:3px solid ${i.type==='falta'?'#dc3545':i.type==='retardo'?'#ff9800':'#ffc107'};"><strong>${i.icon} ${i.text}</strong><br><small>${i.detail}</small></div>`).join('')}
                </div>`).join('')}`;
        }

        function generateIncidentsPDF(list, dateStr, faltas, retardos, sinUniforme) {
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Incidencias ${dateStr}</title><style>
                body{font-family:Arial,sans-serif;margin:40px}.header{text-align:center;margin-bottom:30px;border-bottom:3px solid #0A6EB4;padding-bottom:20px}
                .header h1{color:#0A6EB4;margin:0}.summary{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px 0}
                .summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:15px}
                .summary-item{text-align:center;padding:15px;background:white;border-radius:8px;border:2px solid #e0e0e0}
                .summary-item h3{font-size:32px;margin:0 0 5px 0}.summary-item.falta h3{color:#dc3545}.summary-item.retardo h3{color:#ff9800}.summary-item.uniforme h3{color:#ffc107}
                .student{page-break-inside:avoid;margin:20px 0;padding:15px;border:2px solid #e0e0e0;border-radius:10px}
                .incident{margin:8px 0;padding:10px;background:#f8f9fa;border-radius:5px}
                .incident.falta{border-left:4px solid #dc3545}.incident.retardo{border-left:4px solid #ff9800}.incident.uniforme{border-left:4px solid #ffc107}
                .footer{margin-top:40px;padding-top:20px;border-top:2px solid #e0e0e0;text-align:center;color:#666;font-size:12px}
            </style></head><body>
                <div class="header"><h1>COLEGIO LEONARD EULERD</h1><h2 style="color:#666;font-weight:normal;">Reporte de Incidencias</h2><p>Fecha: ${dateStr}</p></div>
                <div class="summary"><h3 style="text-align:center;color:#0A6EB4;margin-top:0;">Resumen</h3>
                    <div class="summary-grid">
                        <div class="summary-item falta"><h3>${faltas}</h3><p>Faltas</p></div>
                        <div class="summary-item retardo"><h3>${retardos}</h3><p>Retardos</p></div>
                        <div class="summary-item uniforme"><h3>${sinUniforme}</h3><p>Sin Uniforme</p></div>
                        <div class="summary-item"><h3>${list.length}</h3><p>Alumnos</p></div>
                    </div>
                </div>
                <h3 style="color:#0A6EB4;">Detalle por Alumno:</h3>
                ${list.map(s => `<div class="student"><h3>${s.name}</h3><p><strong>CURP:</strong> ${s.code}</p><p><strong>Hora:</strong> ${s.time}</p>
                    ${s.list.map(i => `<div class="incident ${i.type}"><strong>${i.icon} ${i.text}</strong><br><small>${i.detail}</small></div>`).join('')}
                </div>`).join('')}
                <div class="footer"><p>‚ùå FALTA: Entrada despu√©s de 7:05 AM | ‚ö†Ô∏è RETARDO: Entre 7:00-7:05 AM | üëî SIN UNIFORME</p><p>Generado: ${new Date().toLocaleString('es-MX')}</p><p style="font-style:italic;">"Estudia y Vencer√°s"</p></div>
            </body></html>`;
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.onload = () => setTimeout(() => win.print(), 250);
        }

        function generateWeeklyReport() {
            const weekInput = document.getElementById('weekSelect').value;
            if (!weekInput) { document.getElementById('weeklyReport').innerHTML = '<p style="text-align:center;color:#999;">Seleccione una semana</p>'; document.getElementById('statsGrid').innerHTML = ''; return; }
            const [year, week] = weekInput.split('-W');
            const weekStart = getDateOfISOWeek(parseInt(week), parseInt(year));
            const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate() + 6);
            const today = new Date(); today.setHours(0, 0, 0, 0);
            let workDays = 0, workDaysPassed = 0;
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart); d.setDate(weekStart.getDate() + i);
                if (d.getDay() >= 1 && d.getDay() <= 5) { workDays++; if (d <= today) workDaysPassed++; }
            }
            const weekRecords = attendanceRecords.filter(r => {
                const d = parseDate(r.date);
                return d >= weekStart && d <= weekEnd && d.getDay() >= 1 && d.getDay() <= 5 && d <= today;
            });
            const total = weekRecords.length, entradas = weekRecords.filter(r => r.type === 'entrada').length;
            const salidas = weekRecords.filter(r => r.type === 'salida').length, alumnos = new Set(weekRecords.map(r => r.studentCode)).size;
            const info = workDaysPassed < workDays ? `<p style="background:#fff3e0;padding:15px;border-radius:8px;text-align:center;margin:20px 0;border:2px solid #ff9800;">‚ö†Ô∏è Semana en curso: ${workDaysPassed}/${workDays} d√≠as</p>` : `<p style="background:#e8f5e9;padding:15px;border-radius:8px;text-align:center;margin:20px 0;border:2px solid #4caf50;">‚úÖ Semana completa: ${workDays} d√≠as</p>`;
            document.getElementById('statsGrid').innerHTML = info + `<div class="stat-card"><h3>${workDaysPassed}</h3><p>D√≠as</p></div><div class="stat-card"><h3>${total}</h3><p>Registros</p></div><div class="stat-card"><h3>${entradas}</h3><p>Entradas</p></div><div class="stat-card"><h3>${salidas}</h3><p>Salidas</p></div><div class="stat-card"><h3>${alumnos}</h3><p>Alumnos</p></div>`;
            const stats = {};
            students.forEach(s => {
                const recs = weekRecords.filter(r => r.studentCode === s.code);
                const ent = recs.filter(r => r.type === 'entrada');
                const dias = new Set(ent.map(r => r.date)).size;
                stats[s.code] = { name: s.name, dias, pct: workDaysPassed > 0 ? ((dias / workDaysPassed) * 100).toFixed(1) : 0, puntuales: ent.filter(r => r.punctualityStatus === 'PUNTUAL').length, retardos: ent.filter(r => r.punctualityStatus === 'RETARDO').length, faltas: ent.filter(r => r.punctualityStatus === 'FALTA POR IMPUNTUALIDAD').length, conUnif: ent.filter(r => r.uniformComplete === true).length, sinUnif: ent.filter(r => r.uniformComplete === false).length };
            });
            const sorted = Object.entries(stats).sort((a, b) => parseFloat(b[1].pct) - parseFloat(a[1].pct));
            document.getElementById('weeklyReport').innerHTML = `<h3>Reporte por Alumno</h3><table><thead><tr><th>Alumno</th><th>D√≠as</th><th>Puntuales</th><th>Retardos</th><th>Faltas</th><th>Unif ‚úÖ</th><th>Unif ‚ùå</th><th>%</th></tr></thead><tbody>
                ${sorted.map(([code, s]) => {
                    const pct = parseFloat(s.pct);
                    let color = '';
                    if (pct >= 90 && !s.retardos && !s.faltas) color = 'background:#d4edda;';
                    else if (pct >= 70) color = 'background:#fff3cd;';
                    else if (pct < 70 && workDaysPassed > 0) color = 'background:#f8d7da;';
                    return `<tr style="${color}"><td><strong>${escapeHtml(s.name)}</strong></td><td>${s.dias}/${workDaysPassed}</td><td>‚úÖ${s.puntuales}</td><td>‚ö†Ô∏è${s.retardos}</td><td>‚ùå${s.faltas}</td><td>üëî${s.conUnif}</td><td>‚ö†Ô∏è${s.sinUnif}</td><td><strong>${s.pct}%</strong></td></tr>`;
                }).join('')}
            </tbody></table>
            <div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;"><h4>Leyenda:</h4><p>üü¢ Verde: ‚â•90% sin incidencias | üü° Amarillo: 70-89% | üî¥ Rojo: <70%</p></div>`;
        }

        function getDateOfISOWeek(week, year) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const start = simple;
            if (dow <= 4) start.setDate(simple.getDate() - simple.getDay() + 1);
            else start.setDate(simple.getDate() + 8 - simple.getDay());
            return start;
        }

        function parseDate(dateString) {
            const parts = dateString.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
    </script>
</body>
</html>

